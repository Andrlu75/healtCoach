# –ê—É–¥–∏—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å OpenAI API

## –¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
–ü—Ä–æ–≤–µ—Å—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∏–∫–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å OpenAI –º–æ–¥–µ–ª—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º –∫–ª–∏–µ–Ω—Ç–∞–º –∏–ª–∏ –∏—Ö –ø–æ–ª–Ω–æ–º—É –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é.

---

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `/backend/core/ai/openai_provider.py` | –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä OpenAI |
| `/backend/core/ai/factory.py` | Factory pattern –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ |
| `/backend/core/ai/base.py` | –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |
| `/backend/apps/bot/services.py` | –°–µ—Ä–≤–∏—Å—ã —á–∞—Ç–∞ (text, vision, voice) |
| `/backend/apps/meals/services.py` | –ê–Ω–∞–ª–∏–∑ –µ–¥—ã, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è, –ø–µ—Ä–µ—Å—á—ë—Ç |
| `/backend/apps/persona/models.py` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏ –ø–µ—Ä—Å–æ–Ω—ã |

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏
- **gpt-4o** ‚Äî Vision API, –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **gpt-4o-mini** ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **whisper-1** ‚Äî —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ

---

## –ó–ê–î–ê–ß–ò –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

### –ì—Ä—É–ø–ø–∞ 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

#### –ó–∞–¥–∞—á–∞ 1.1: –ê—É–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π OpenAI
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/core/ai/openai_provider.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è ISSUES FOUND

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π OpenAI
- [x] –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_handle_openai_error()` —Å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- [x] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è: RateLimitError, APIConnectionError, APIError, AuthenticationError, TimeoutError
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ (warning/error/critical)

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∞—É–¥–∏—Ç–µ:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ try/except –≤ –º–µ—Ç–æ–¥–∞—Ö (—Å–º. FIX-–∑–∞–¥–∞—á—É –Ω–∏–∂–µ)

**–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
```python
# –°–µ–π—á–∞—Å –ª–æ–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ BadRequestError
except openai.BadRequestError as e:
    if 'temperature' in str(e):
        kwargs.pop('temperature', None)
        response = await self.client.chat.completions.create(**kwargs)
    else:
        raise
```

---

#### –ó–∞–¥–∞—á–∞ 1.2: –ê—É–¥–∏—Ç retry –ª–æ–≥–∏–∫–∏
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/core/ai/openai_provider.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è ISSUES FOUND

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `tenacity` –≤ requirements
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `_call_with_retry()` —Å exponential backoff
- [x] 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ 1s, 2s, 4s
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∞—É–¥–∏—Ç–µ:**
1. **[FIX-15] MEDIUM** ‚Äî –î–µ–∫–æ—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ (–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
2. **[FIX-16] HIGH** ‚Äî –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ retry –∏ asyncio.wait_for

---

#### –ó–∞–¥–∞—á–∞ 1.3: –ê—É–¥–∏—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/core/ai/openai_provider.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ç–∞–π–º–∞—É—Ç–æ–≤: DEFAULT_TIMEOUT, VISION_TIMEOUT, TRANSCRIBE_TIMEOUT
- [x] OpenAI –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å httpx.Timeout(60.0, connect=10.0)
- [x] Vision: 90 —Å–µ–∫—É–Ω–¥
- [x] Transcribe: 120 —Å–µ–∫—É–Ω–¥
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ asyncio.TimeoutError —Å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º

---

### –ì—Ä—É–ø–ø–∞ 2: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

#### –ó–∞–¥–∞—á–∞ 2.1: –ê—É–¥–∏—Ç JSON –ø–∞—Ä—Å–∏–Ω–≥–∞
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/meals/services.py`, `/backend/apps/meals/schemas.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è ISSUES FOUND

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω fallback: None –≤–º–µ—Å—Ç–æ 0 –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–∞—Ä—Å–∏–Ω–≥–∞
- [x] –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `parse_error: True` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- [x] –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `schemas.py` —Å Pydantic –º–æ–¥–µ–ª—è–º–∏
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ (—Å—Ç—Ä–æ–∫–∏ ‚Üí —á–∏—Å–ª–∞)
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (confidence 0-100)
- [x] json_mode=True –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∞—É–¥–∏—Ç–µ:**
1. **[FIX-20] LOW** ‚Äî –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ –≤ Pydantic —Å—Ö–µ–º–∞—Ö
2. **[FIX-21] MEDIUM** ‚Äî –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç model_config –¥–ª—è extra –ø–æ–ª–µ–π

---

#### –ó–∞–¥–∞—á–∞ 2.2: –ê—É–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ refusals –∏ –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/core/ai/openai_provider.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- [x] Refusal ‚Üí —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –ü—É—Å—Ç–æ–π content ‚Üí fallback —Å–æ–æ–±—â–µ–Ω–∏–µ
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ finish_reason: stop, length, content_filter
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `is_truncated` –≤ AIResponse
- [x] –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ù–ï —É—Ö–æ–¥—è—Ç –∫–ª–∏–µ–Ω—Ç—É
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç–∫–∞–∑–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

---

#### –ó–∞–¥–∞—á–∞ 2.3: –ê—É–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/meals/schemas.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- [x] Pydantic field_validators –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫ ‚Üí —á–∏—Å–ª–∞
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ float –¥–ª—è –≤—Å–µ—Ö –Ω—É—Ç—Ä–∏–µ–Ω—Ç–æ–≤
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è ge=0 –¥–ª—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è confidence: 0-100 —Å –∞–≤—Ç–æ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
- [x] –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

### –ì—Ä—É–ø–ø–∞ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤

#### –ó–∞–¥–∞—á–∞ 3.1: –ê—É–¥–∏—Ç –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –µ–¥—ã
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/meals/services.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è MINOR ISSUES

**–ü—Ä–æ–º–ø—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã:**
- [x] `ANALYZE_FOOD_PROMPT` ‚Äî –±–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ (—Å—Ç—Ä–æ–∫–∏ 128-141)
- [x] `CLASSIFY_AND_ANALYZE_PROMPT` ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è + –∞–Ω–∞–ª–∏–∑ (—Å—Ç—Ä–æ–∫–∏ 105-126)
- [x] `ANALYZE_FOOD_SMART_PROMPT` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ (—Å—Ç—Ä–æ–∫–∏ 144-194)
- [x] `CLASSIFY_PROMPT` ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–æ—Ç–æ (—Å—Ç—Ä–æ–∫–∏ 98-103)
- [x] `CLASSIFY_CORRECTION_PROMPT` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 50-54)
- [x] `RECALCULATE_PROMPT` ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç –ö–ë–ñ–£ (—Å—Ç—Ä–æ–∫–∏ 56-73)
- [x] `RECALCULATE_MINIAPP_PROMPT` ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç –¥–ª—è miniapp (—Å—Ç—Ä–æ–∫–∏ 75-96)
- [x] `ADD_INGREDIENT_PROMPT` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 197-215)

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ JSON —Ñ–æ—Ä–º–∞—Ç —á—ë—Ç–∫–æ —É–∫–∞–∑–∞–Ω –≤–æ –≤—Å–µ—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è "–±–µ–∑ markdown-–æ–±—ë—Ä—Ç–∫–∏" –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- ‚úÖ `ANALYZE_FOOD_SMART_PROMPT` –∏–º–µ–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ few-shot –ø—Ä–∏–º–µ—Ä—ã
- ‚úÖ `ANALYZE_FOOD_SMART_PROMPT` –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã GPT-4o
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–µ –ø–æ—Ä—Ü–∏–∏
- ‚úÖ confidence –ø–æ–ª–µ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ json_mode=True –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–∞—Ö

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
1. **[FIX-30] LOW** ‚Äî –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏–º—ë–Ω –ø–æ–ª–µ–π: `carbohydrates` vs `carbs`
2. **[FIX-31] LOW** ‚Äî –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ few-shot –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö
3. **[FIX-32] LOW** ‚Äî –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ edge cases (–Ω–µ—á—ë—Ç–∫–æ–µ —Ñ–æ—Ç–æ, —É–ø–∞–∫–æ–≤–∫–∞ —Å —ç—Ç–∏–∫–µ—Ç–∫–æ–π)

---

#### –ó–∞–¥–∞—á–∞ 3.2: –ê—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –±–æ—Ç–∞
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/bot/services.py`, `/backend/apps/persona/models.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] –§—É–Ω–∫—Ü–∏—è `_build_system_prompt()` (—Å—Ç—Ä–æ–∫–∏ 95-111)
- [x] –§—É–Ω–∫—Ü–∏—è `_build_client_context()` (—Å—Ç—Ä–æ–∫–∏ 45-92)
- [x] –§—É–Ω–∫—Ü–∏—è `_detect_gender_from_name()` (—Å—Ç—Ä–æ–∫–∏ 25-42)
- [x] –ú–æ–¥–µ–ª—å `BotPersona` (persona/models.py)

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–∞ –ø–æ —Ä—É—Å—Å–∫–æ–º—É –∏–º–µ–Ω–∏ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ (–ù–∏–∫–∏—Ç–∞, –ò–ª—å—è –∏ —Ç.–¥.)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∞ (male/female/–º/–º—É–∂—Å–∫–æ–π ‚Üí –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏–∑ birth_date
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ None –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –ü—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É (–Ω–µ None)
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ–ª –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª –∏–∑–≤–µ—Å—Ç–µ–Ω
- ‚úÖ Defaults –≤ –º–æ–¥–µ–ª–∏: temperature=0.7, max_tokens=600, system_prompt=''
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤: text/vision/voice

**–ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç:**
- [x] –ü–æ–ª (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏)
- [x] –ò–º—è, –≤–æ–∑—Ä–∞—Å—Ç
- [x] –†–æ—Å—Ç, –≤–µ—Å
- [x] –î–Ω–µ–≤–Ω—ã–µ –Ω–æ—Ä–º—ã –ö–ë–ñ–£ (—Ç–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ)

**–ü—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.**

---

#### –ó–∞–¥–∞—á–∞ 3.3: –ê—É–¥–∏—Ç –ø—Ä–æ–º–ø—Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–∏—Ç–∞–Ω–∏—è
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/meals/services.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] `DEFAULT_NUTRITION_PROGRAM_CONTROLLER_PROMPT` (—Å—Ç—Ä–æ–∫–∏ 26-48)
- [x] –§—É–Ω–∫—Ü–∏—è `get_program_controller_feedback()` (—Å—Ç—Ä–æ–∫–∏ 403-699)
- [x] –§—É–Ω–∫—Ü–∏—è `_get_program_history()` (—Å—Ç—Ä–æ–∫–∏ 262-330)

**–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:**
- [x] `{program_info}` ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (—Å—Ç—Ä–æ–∫–∞ 556)
- [x] `{planned_meal}` ‚Äî —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º, –≤—Ä–µ–º–µ–Ω–µ–º, —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º–∏/–∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–º–∏ (—Å—Ç—Ä–æ–∫–∏ 484-502)
- [x] `{actual_meal}` ‚Äî –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞ —Å –ö–ë–ñ–£ –∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ (—Å—Ç—Ä–æ–∫–∏ 576-590)
- [x] `{next_meal}` ‚Äî —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º –∏–ª–∏ "–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –Ω–∞ —Å–µ–≥–æ–¥–Ω—è" (—Å—Ç—Ä–æ–∫–∏ 504-553)
- [x] `{program_history}` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ compliance —Å % –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è–º–∏ (—Å—Ç—Ä–æ–∫–∏ 262-330)

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ KeyError fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç (—Å—Ç—Ä–æ–∫–∏ 651-659)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (—Å—Ç—Ä–æ–∫–∞ 541)
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º compliance
- ‚úÖ –ú–∞–ø–ø–∏–Ω–≥ —Ä—É—Å—Å–∫–∏—Ö —Ç–∏–ø–æ–≤ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ (ru_to_en_meal_type)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ –ø–µ—Ä—Å–æ–Ω—ã
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ style_description –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä–∞ –≤ –ø—Ä–æ–º–ø—Ç

**–ü—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.**

---

### –ì—Ä—É–ø–ø–∞ 4: API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### –ó–∞–¥–∞—á–∞ 4.1: –ê—É–¥–∏—Ç Vision API
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/core/ai/openai_provider.py`, `/backend/apps/meals/services.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] –§–æ—Ä–º–∞—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Äî base64 (openai_provider.py:266)
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ media_type –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (image/jpeg –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- [x] –ü–∞—Ä–∞–º–µ—Ç—Ä `detail` (low/high/auto) ‚Äî –µ—Å—Ç—å, default='low'
- [x] –¢–∞–π–º–∞—É—Ç—ã ‚Äî VISION_TIMEOUT=90s (openai_provider.py:22)
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚Äî —á–µ—Ä–µ–∑ _handle_openai_error()

**–§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã:**
- [x] `analyze_image()` –≤ OpenAIProvider (openai_provider.py:240-335)
- [x] `get_ai_vision_response()` –≤ bot/services.py (—Å—Ç—Ä–æ–∫–∏ 284-354)
- [x] `classify_image()` –≤ meals/services.py (—Å—Ç—Ä–æ–∫–∏ 702-725)
- [x] `classify_and_analyze()` –≤ meals/services.py (—Å—Ç—Ä–æ–∫–∏ 728-770)
- [x] `analyze_food()` –≤ meals/services.py (—Å—Ç—Ä–æ–∫–∏ 773-823)
- [x] `analyze_food_smart()` –≤ meals/services.py (—Å—Ç—Ä–æ–∫–∏ 1535-1639)

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è OpenAI Vision)
- ‚úÖ json_mode=True –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ JSON
- ‚úÖ temperature=0.0-0.2 –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞
- ‚úÖ detail='high' –¥–ª—è SMART —Ä–µ–∂–∏–º–∞ (–ª—É—á—à–µ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ)
- ‚úÖ VISION_TIMEOUT=90s –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ vision –∑–∞–ø—Ä–æ—Å–∞–º
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage –¥–ª—è –≤—Å–µ—Ö vision –≤—ã–∑–æ–≤–æ–≤

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (20MB) –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –∫–æ–¥–µ ‚Äî OpenAI API —Å–∞–º –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É
- –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, —Ç.–∫. BadRequestError –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

---

#### –ó–∞–¥–∞—á–∞ 4.2: –ê—É–¥–∏—Ç Whisper API (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π
**–§–∞–π–ª—ã:** `/backend/core/ai/openai_provider.py`, `/backend/apps/bot/handlers/voice.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è MINOR ISSUES

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] `transcribe_audio()` –≤ OpenAIProvider (openai_provider.py:337-361)
- [x] `transcribe_audio()` –≤ bot/services.py (—Å—Ç—Ä–æ–∫–∏ 357-377)
- [x] `handle_voice()` –≤ handlers/voice.py (—Å—Ç—Ä–æ–∫–∏ 12-43)

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ TRANSCRIBE_TIMEOUT=120s –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∞—É–¥–∏–æ
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
- ‚úÖ –Ø–∑—ã–∫ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ (language='ru')
- ‚úÖ Fallback –Ω–∞ openai –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –±–µ–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–∏—è (anthropic, deepseek)
- ‚úÖ –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ handler
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage (—Ö–æ—Ç—è –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è whisper)

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
1. **[FIX-33] LOW** ‚Äî –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –∂—ë—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω –∫–∞–∫ 'audio.ogg'
2. **[FIX-34] LOW** ‚Äî –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (25MB –ª–∏–º–∏—Ç OpenAI)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏—à–∏–Ω—ã/—à—É–º–∞ ‚Äî Whisper —Å–∞–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (<3 —Å–µ–∫) ‚Äî —Ä–∞–±–æ—Ç–∞—é—Ç, Whisper —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

---

#### –ó–∞–¥–∞—á–∞ 4.3: –ê—É–¥–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/bot/services.py`, `/backend/core/ai/tokens.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è ISSUES FOUND

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- [x] –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `core/ai/tokens.py` —Å tiktoken
- [x] –§—É–Ω–∫—Ü–∏–∏: count_tokens, count_messages_tokens, trim_messages_to_token_limit
- [x] –õ–∏–º–∏—Ç—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π (GPT-4o, Claude, DeepSeek)
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ —Ç–æ–∫–µ–Ω–∞–º
- [x] –†–µ–∑–µ—Ä–≤ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∞—É–¥–∏—Ç–µ:**
1. **[FIX-23] LOW** ‚Äî –ù–∏–∑–∫–∏–π maxsize –¥–ª—è lru_cache (4 –≤–º–µ—Å—Ç–æ 16)
2. **[FIX-24] MEDIUM** ‚Äî TypeError –ø—Ä–∏ None content

---

#### –ó–∞–¥–∞—á–∞ 4.4: –ê—É–¥–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–æ–¥–µ–ª–µ–π
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π
**–§–∞–π–ª—ã:** –≤—Å–µ –º–µ—Å—Ç–∞ –≤—ã–∑–æ–≤–∞ `provider.complete()` –∏ `analyze_image()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] Temperature –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á (29 –º–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [x] Max tokens –ø–æ —Ç–∏–ø–∞–º –∑–∞–¥–∞—á (31 –º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `json_mode=True` (9 –º–µ—Å—Ç)

**Temperature ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
| –¢–∏–ø –∑–∞–¥–∞—á–∏ | Temperature | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------------|-------------|-------------|
| –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (YES/NO) | 0.0 | ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π |
| –ü–µ—Ä–µ—Å—á—ë—Ç –ö–ë–ñ–£ | 0.0 | ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π |
| –ü–∞—Ä—Å–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ | 0.0 | ‚úÖ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π |
| JSON –∞–Ω–∞–ª–∏–∑ –µ–¥—ã | 0.2 | ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π JSON |
| Compliance –∞–Ω–∞–ª–∏–∑ | 0.2 | ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π |
| –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ | 0.3 | ‚úÖ –î–æ–ø—É—Å—Ç–∏–º–æ |
| –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã | 0.7 | ‚úÖ –¢–≤–æ—Ä—á–µ—Å–∫–∏–π |
| Controller feedback | 0.7 | ‚úÖ –¢–≤–æ—Ä—á–µ—Å–∫–∏–π |
| –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è | 0.9 | ‚úÖ –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ |
| –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ | persona.temperature | ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π |

**Max tokens ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
| –¢–∏–ø –∑–∞–¥–∞—á–∏ | Max Tokens | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------------|-----------|-------------|
| –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è | 5-10 | ‚úÖ YES/NO |
| –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã | 100-150 | ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è |
| Controller/–ø–µ—Ä–µ—Å—á—ë—Ç | 200-300 | ‚úÖ –°—Ä–µ–¥–Ω–∏–µ |
| –ê–Ω–∞–ª–∏–∑ –µ–¥—ã | 500 | ‚úÖ JSON —Å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ |
| Compliance/shopping | 800-1000 | ‚úÖ –î–ª–∏–Ω–Ω—ã–µ |
| SMART —Ä–µ–∂–∏–º | 4096 | ‚úÖ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è |
| –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ | persona.max_tokens (600) | ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π |

**json_mode=True –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –≤–µ–∑–¥–µ –≥–¥–µ –Ω—É–∂–µ–Ω JSON –æ—Ç–≤–µ—Ç.

**seed –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** ‚Äî —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, —Ç.–∫. –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

---

### –ì—Ä—É–ø–ø–∞ 5: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

#### –ó–∞–¥–∞—á–∞ 5.1: –ê—É–¥–∏—Ç –ª–æ–≥–∏–∫–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–π –±–ª—é–¥
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/meals/services.py`, `/backend/apps/bot/handlers/text.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è MINOR ISSUES

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] `get_recent_meal()` (meals/services.py:1088-1101) ‚Äî –æ–∫–Ω–æ 5 –º–∏–Ω—É—Ç
- [x] `is_meal_correction()` (meals/services.py:1104-1128) ‚Äî AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è YES/NO
- [x] `recalculate_meal()` (meals/services.py:1487-1530) ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç –ö–ë–ñ–£
- [x] `recalculate_meal_for_client()` (meals/services.py:1326-1484) ‚Äî miniapp –≤–µ—Ä—Å–∏—è
- [x] `_handle_meal_correction()` (handlers/text.py:50-126) ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ temperature=0 –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è
- ‚úÖ temperature=0.0 –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –ö–ë–ñ–£
- ‚úÖ json_mode=True –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞
- ‚úÖ Fallback –Ω–∞ –ø—É—Å—Ç–æ–π dict –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –ø–µ—Ä–µ—Å—á—ë—Ç–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ InteractionLog
- ‚úÖ correction_addendum –≤ –ø—Ä–æ–º–ø—Ç–µ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
1. **[FIX-35] LOW** ‚Äî –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ
2. **[FIX-36] LOW** ‚Äî –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è—Ö

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –û–±–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è MVP ‚Äî –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

---

#### –ó–∞–¥–∞—á–∞ 5.2: –ê—É–¥–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/reminders/services.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] `generate_smart_text()` (—Å—Ç—Ä–æ–∫–∏ 57-109) ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
- [x] `send_reminder_message()` (—Å—Ç—Ä–æ–∫–∏ 22-54) ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- [x] –ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö
- [x] Fallback –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ temperature=0.9 –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
- ‚úÖ max_tokens=100 ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ Fallback –Ω–∞ `reminder.message or reminder.title` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `_build_client_context()`
- ‚úÖ –£—á—ë—Ç –ø–æ–ª–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø—Ä–æ–º–ø—Ç–µ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å exception
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage —á–µ—Ä–µ–∑ `log_ai_usage_sync()`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –ö–æ–¥ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π, fallback –Ω–∞ —Å—Ç–∞—Ç–∏–∫—É –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö
- –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –≤—ã—Å–æ–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π

---

#### –ó–∞–¥–∞—á–∞ 5.3: –ê—É–¥–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/reports/services.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] `generate_ai_summary()` (reports/services.py:66-114) ‚Äî AI —Å–≤–æ–¥–∫–∞
- [x] `generate_report()` (reports/services.py:28-63) ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞
- [x] –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è summary
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [x] Fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö AI

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ temperature=0.7 –¥–ª—è —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö —Å–≤–æ–¥–æ–∫
- ‚úÖ max_tokens=300 ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- ‚úÖ Fallback –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä—Å–æ–Ω—ã/–∫–æ–Ω—Ñ–∏–≥–∞
- ‚úÖ Fallback –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö AI
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `_build_client_context()`
- ‚úÖ –£—á—ë—Ç –ø–æ–ª–∞ –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage —á–µ—Ä–µ–∑ `log_ai_usage_sync()`
- ‚úÖ JSON –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Å `ensure_ascii=False` –∏ `default=str`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –ö–æ–¥ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π, fallback –Ω–∞ –ø—É—Å—Ç—É—é —Å–≤–æ–¥–∫—É –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö
- PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞ –æ—Ç AI

---

#### –ó–∞–¥–∞—á–∞ 5.4: –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è usage
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π
**–§–∞–π–ª—ã:** `/backend/apps/bot/services.py`, `/backend/core/ai/model_fetcher.py`

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚úÖ AUDIT PASSED

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- [x] `_log_usage()` –≤ bot/services.py (—Å—Ç—Ä–æ–∫–∏ 180-209)
- [x] `log_ai_usage()` –≤ model_fetcher.py ‚Äî async –≤–µ—Ä—Å–∏—è
- [x] `log_ai_usage_sync()` –≤ model_fetcher.py ‚Äî sync –≤–µ—Ä—Å–∏—è
- [x] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- [x] –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: `input_tokens`/`output_tokens` –∏ `prompt_tokens`/`completion_tokens`
- ‚úÖ Fallback –Ω–∞ 0 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `get_cached_pricing()`
- ‚úÖ Warning –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ pricing
- ‚úÖ cost_usd –∫–∞–∫ Decimal –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage –≤–æ –≤—Å–µ—Ö AI –≤—ã–∑–æ–≤–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω OpenRouter —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ model_fetcher.py
- Whisper –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤ (usage –ø—É—Å—Ç–æ–π) ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ

---

### –ì—Ä—É–ø–ø–∞ 6: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### –ó–∞–¥–∞—á–∞ 6.1: –ê—É–¥–∏—Ç –∑–∞—â–∏—Ç—ã –æ—Ç prompt injection
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π
**–§–∞–π–ª—ã:** –≤—Å–µ –º–µ—Å—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ –≤ –ø—Ä–æ–º–ø—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è ACCEPTABLE RISK

**–ú–µ—Å—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –≤–≤–æ–¥–æ–º –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö:**
- [x] CLASSIFY_CORRECTION_PROMPT (`{user_text}`) ‚Äî meals/services.py:52
- [x] RECALCULATE_PROMPT (`{user_text}`) ‚Äî meals/services.py:62
- [x] RECALCULATE_MINIAPP_PROMPT (`{correction}`) ‚Äî meals/services.py:83
- [x] Caption –≤ vision –ø—Ä–æ–º–ø—Ç–∞—Ö (10+ –º–µ—Å—Ç)

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞—â–∏—Ç—ã:**
- ‚úÖ `json_mode=True` ‚Äî –º–æ–¥–µ–ª—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ JSON —Ñ–æ—Ä–º–∞—Ç–æ–º
- ‚úÖ `temperature=0.0` –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- ‚úÖ `max_tokens` –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ‚Äî –∞—Ç–∞–∫—É—é—â–∏–π –Ω–µ –º–æ–∂–µ—Ç –∑–∞—Å—Ç–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∏—Ç—å –º–Ω–æ–≥–æ
- ‚úÖ System prompt –æ—Ç–¥–µ–ª—ë–Ω –æ—Ç user message ‚Äî API —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
- ‚úÖ –û—Ç–≤–µ—Ç—ã YES/NO –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ ‚Äî –Ω–µ –¥–∞—ë—Ç —Å–≤–æ–±–æ–¥—ã

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞—â–∏—Ç—ã:**
1. **[FIX-37] LOW** ‚Äî –ù–µ—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
2. **[FIX-38] LOW** ‚Äî –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã –≤–≤–æ–¥–∞ (–∫—Ä–æ–º–µ Telegram ~4096)
3. **[FIX-39] LOW** ‚Äî –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: –ù–ò–ó–ö–ò–ô**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –∫–ª–∏–µ–Ω—Ç—ã –∫–æ—É—á–µ–π, –Ω–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∞—Ç–∞–∫—É—é—â–∏–µ
- –ú–æ–¥–µ–ª—å –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (—Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
- Worst case ‚Äî –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –µ–¥—ã ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–∏—Ç –≤—Ä—É—á–Ω—É—é
- json_mode —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ injection –∞—Ç–∞–∫

---

### –ì—Ä—É–ø–ø–∞ 7: –ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã

#### –ó–∞–¥–∞—á–∞ 7.1: –ê–Ω–∞–ª–∏–∑ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û ‚Üí AUDITED
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∞—É–¥–∏—Ç–∞:** ‚ö†Ô∏è DOCUMENTED FOR FUTURE

**–ê–Ω–∞–ª–∏–∑ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤:**

| –ú–µ—Ö–∞–Ω–∏–∑–º | –°—Ç–∞—Ç—É—Å | –í–ª–∏—è–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|----------|--------|---------|-----------|
| **Rate Limiting** | ‚ùå –ù–µ—Ç | 429 –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∏–∫–∞—Ö | üü† HIGH |
| **Circuit Breaker** | ‚ùå –ù–µ—Ç | –ö–∞—Å–∫–∞–¥–Ω—ã–µ —Å–±–æ–∏ | üü° MEDIUM |
| **Graceful Degradation** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –ï—Å—Ç—å fallback –¥–ª—è transcribe | üü° MEDIUM |
| **Token Counting** | ‚úÖ –ï—Å—Ç—å | tokens.py —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω | ‚úÖ DONE |
| **Streaming** | ‚ùå –ù–µ—Ç | –î–æ–ª–≥–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ | üü¢ LOW |
| **Caching** | ‚ùå –ù–µ—Ç | –õ–∏—à–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã | üü¢ LOW |
| **Cost Control** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | AIUsageLog –ª–æ–≥–∏—Ä—É–µ—Ç | üü° MEDIUM |
| **Model Availability** | ‚ùå –ù–µ—Ç | –û—à–∏–±–∫–∏ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ | üü¢ LOW |
| **Request Queue** | ‚ùå –ù–µ—Ç | Rate limit –ø—Ä–∏ –ø–∏–∫–∞—Ö | üü† HIGH |
| **Monitoring/Alerts** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –õ–æ–≥–∏ –µ—Å—Ç—å, –∞–ª–µ—Ä—Ç–æ–≤ –Ω–µ—Ç | üü° MEDIUM |

**–ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (—É–ª—É—á—à–µ–Ω–∏—è –∏–∑ –∞—É–¥–∏—Ç–∞):**
- ‚úÖ Retry —Å exponential backoff (tenacity)
- ‚úÖ –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ OpenAI
- ‚úÖ Token counting –∏ trimming (tokens.py)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage –∏ cost

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ:**
1. **Rate Limiting** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å per-client rate limiting —á–µ—Ä–µ–∑ Redis
2. **Circuit Breaker** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å circuit breaker —á–µ—Ä–µ–∑ tenacity –∏–ª–∏ pybreaker
3. **Alerting** ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –≤ Sentry/Datadog –Ω–∞ –∞–Ω–æ–º–∞–ª–∏–∏ usage

---

## –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–•–û–î–ö–ò

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–≤—ã—è–≤–ª–µ–Ω—ã –ø—Ä–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏)

1. **–ù–µ—Ç retry –ª–æ–≥–∏–∫–∏**
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ–ª–Ω–æ–º—É –æ—Ç–∫–∞–∑—É
   - –§–∞–π–ª: `openai_provider.py`

2. **–ù–µ–ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**
   - –õ–æ–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ `BadRequestError`
   - –ü—Ä–æ–ø—É—â–µ–Ω—ã: `RateLimitError`, `APIError`, `Timeout`

3. **–°–ª–∞–±–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è JSON**
   - –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
   - AI –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–π JSON

4. **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ fallback –∑–Ω–∞—á–µ–Ω–∏—è**
   - `calories: 0` –≤–º–µ—Å—Ç–æ `None` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - –ò—Å–∫–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

5. **–•—Ä—É–ø–∫–∏–π markdown stripping**
   ```python
   if content.startswith('```'):
       content = content.split('\n', 1)[1]  # –ú–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è
   ```

6. **Hardcoded temperature = 0.7**
   - –î–∞–∂–µ –¥–ª—è JSON –∑–∞–¥–∞—á –≥–¥–µ –Ω—É–∂–µ–Ω –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º

7. **–ù–µ—Ç —è–≤–Ω—ã—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤**
   - –ó–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –≤–∏—Å–µ—Ç—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ –¥–æ–ª–≥–æ

8. **Double AI calls –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**
   - –ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–π call —É–ø–∞–¥—ë—Ç, –ø–µ—Ä–≤—ã–π –Ω–µ –æ—Ç–∫–∞—Ç–∏—Ç—Å—è

9. **Refusal —É—Ö–æ–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç—É**
   - `[–û—Ç–∫–∞–∑ –º–æ–¥–µ–ª–∏: ...]` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç

10. **–ù–µ—Ç token counting**
    - –ú–æ–∂–Ω–æ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

---

## –ü–†–ò–û–†–ò–¢–ï–ó–ê–¶–ò–Ø

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –±–∞–≥–∏)
1. –ó–∞–¥–∞—á–∞ 1.1 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
2. –ó–∞–¥–∞—á–∞ 1.2 ‚Äî Retry –ª–æ–≥–∏–∫–∞
3. –ó–∞–¥–∞—á–∞ 2.1 ‚Äî JSON –ø–∞—Ä—Å–∏–Ω–≥

### –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è (–≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫)
4. –ó–∞–¥–∞—á–∞ 1.3 ‚Äî –¢–∞–π–º–∞—É—Ç—ã
5. –ó–∞–¥–∞—á–∞ 2.2 ‚Äî Refusals
6. –ó–∞–¥–∞—á–∞ 4.1 ‚Äî Vision API
7. –ó–∞–¥–∞—á–∞ 6.1 ‚Äî Prompt injection

### –ü–ª–∞–Ω–æ–≤–æ (—Å—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫)
8. –ó–∞–¥–∞—á–∞ 3.1 ‚Äî –ü—Ä–æ–º–ø—Ç—ã –µ–¥—ã
9. –ó–∞–¥–∞—á–∞ 5.1 ‚Äî –£—Ç–æ—á–Ω–µ–Ω–∏—è –±–ª—é–¥
10. –ó–∞–¥–∞—á–∞ 4.3 ‚Äî –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

### –ü—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (—É–ª—É—á—à–µ–Ω–∏—è)
11-17. –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏

---

## –ü–†–û–ì–†–ï–°–°

| –ì—Ä—É–ø–ø–∞ | –í—Å–µ–≥–æ | –í—ã–ø–æ–ª–Ω–µ–Ω–æ | Audited | % |
|--------|-------|-----------|---------|---|
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | 3 | 3 | 3 | 100% |
| –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö | 3 | 3 | 3 | 100% |
| –ü—Ä–æ–º–ø—Ç—ã | 3 | 3 | 3 | 100% |
| API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | 4 | 4 | 4 | 100% |
| –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ | 4 | 4 | 4 | 100% |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | 1 | 1 | 1 | 100% |
| –ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ | 1 | 1 | 1 | 100% |
| **–ò–¢–û–ì–û** | **19** | **19** | **19** | **100%** |

---

## FIX-–ó–ê–î–ê–ß–ò –ò–ó –ê–£–î–ò–¢–ê

### [FIX-15] –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 1.2
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM
**–¢–∏–ø:** OPTIMIZATION
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `_call_with_retry` —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ.

**–†–µ—à–µ–Ω–∏–µ:** –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `_retry_decorator` —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è (—Å—Ç—Ä–æ–∫–∏ 48-55).

---

### [FIX-16] –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ retry –∏ asyncio.wait_for
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 1.2
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ HIGH
**–¢–∏–ø:** BUG
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `analyze_image()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤–æ–π–Ω–æ–π —Ç–∞–π–º–∞—É—Ç ‚Äî asyncio.wait_for —Å–Ω–∞—Ä—É–∂–∏ –∏ retry delays –≤–Ω—É—Ç—Ä–∏. –í–Ω–µ—à–Ω–∏–π —Ç–∞–π–º–∞—É—Ç –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–∞–Ω—å—à–µ retry.

**–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞–Ω asyncio.wait_for, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è per-request timeout —á–µ—Ä–µ–∑ `kwargs['timeout'] = VISION_TIMEOUT.read`.

---

### [FIX-17] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ try/except
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 1.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM
**–¢–∏–ø:** REFACTOR
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–ª–æ–∫ except —Å 5 —Ç–∏–ø–∞–º–∏ –æ—à–∏–±–æ–∫ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ.

**–í–µ—Ä–¥–∏–∫—Ç:** –õ–æ–≥–∏–∫–∞ –≤ –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ —Ä–∞–∑–Ω–∞—è (—Ä–∞–∑–Ω—ã–µ fallback-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏ BadRequestError). –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä/context manager —É—Å–ª–æ–∂–Ω–∏—Ç –∫–æ–¥ –±–µ–∑ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑—ã –¥–ª—è 2 –ø–æ—Ö–æ–∂–∏—Ö –±–ª–æ–∫–æ–≤. –ö–æ–¥ –ø–æ–Ω—è—Ç–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

### [FIX-18] Magic numbers –¥–ª—è GPT-5 max_tokens
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 1.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** REFACTOR
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** `max(max_tokens * 10, 8192)` –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã `GPT5_TEXT_TOKEN_MULTIPLIER`, `GPT5_TEXT_MIN_TOKENS`, `GPT5_VISION_TOKEN_MULTIPLIER`, `GPT5_VISION_MIN_TOKENS` —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ (—Å—Ç—Ä–æ–∫–∏ 25-30).

---

### [FIX-20] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ –≤ Pydantic
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 2.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** REFACTOR
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** `convert_to_float` validator –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ FoodAnalysis –∏ Ingredient.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è Annotated types: `NutritionFloat` –∏ `ConfidenceInt` —Å `BeforeValidator` (—Å—Ç—Ä–æ–∫–∏ 37-38).

---

### [FIX-21] –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç model_config –¥–ª—è extra –ø–æ–ª–µ–π
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 2.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM
**–¢–∏–ø:** BUG
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç AI –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π –º–æ–¥–µ–ª—å —É–ø–∞–¥—ë—Ç.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `model_config = {'extra': 'ignore'}` –≤–æ –≤—Å–µ Pydantic –º–æ–¥–µ–ª–∏ (FoodAnalysis, Ingredient, SmartFoodAnalysis).

---

### [FIX-23] –ù–∏–∑–∫–∏–π maxsize –¥–ª—è lru_cache tiktoken
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 4.3
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** OPTIMIZATION
**–°—Ç–∞—Ç—É—Å:** ‚ùå NOT AN ISSUE

**–ü—Ä–æ–±–ª–µ–º–∞:** maxsize=4 –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –º–æ–¥–µ–ª–µ–π (gpt-4o-2024-05-13).

**–í–µ—Ä–¥–∏–∫—Ç:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è. –ö—ç—à–∏—Ä—É–µ—Ç—Å—è `encoding_name` (—Ç–æ–ª—å–∫–æ 2 –∑–Ω–∞—á–µ–Ω–∏—è: 'o200k_base' –∏ 'cl100k_base'), –∞ –Ω–µ –∏–º—è –º–æ–¥–µ–ª–∏. maxsize=4 –±–æ–ª–µ–µ —á–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

---

### [FIX-24] TypeError –ø—Ä–∏ None content –≤ count_tokens
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 4.3
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM
**–¢–∏–ø:** BUG
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** `msg.get('content', '')` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –µ—Å–ª–∏ content=None.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω `msg.get('content') or ''` (—Å—Ç—Ä–æ–∫–∞ 105 –≤ tokens.py).

---

### [FIX-25] TypeError –ø—Ä–∏ None content –≤ trim_messages_to_token_limit
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 4.3
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ HIGH
**–¢–∏–ø:** BUG
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `trim_messages_to_token_limit` (tokens.py:166) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `msg.get('content', '')` –≤–º–µ—Å—Ç–æ `msg.get('content') or ''`. –¢–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞ —á—Ç–æ FIX-24, –Ω–æ –ø—Ä–æ–ø—É—â–µ–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ `msg.get('content') or ''`.

---

### [FIX-26] –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç fallback max_tokens –≤ complete()
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 1.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° MEDIUM
**–¢–∏–ø:** BUG
**–°—Ç–∞—Ç—É—Å:** ‚úÖ DONE

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `complete()` –Ω–µ –±—ã–ª–æ fallback –Ω–∞ `max_tokens` –ø—Ä–∏ BadRequestError —Å 'max_completion_tokens'. –í `analyze_image` —Ç–∞–∫–æ–π fallback –±—ã–ª, –Ω–æ –≤ `complete` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ BadRequestError —Å 'max_completion_tokens' –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ analyze_image.

---

## –°–í–û–î–ö–ê FIX-–ó–ê–î–ê–ß

| ID | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°—Ç–∞—Ç—É—Å |
|----|-----------|--------|
| FIX-15 | üü° MEDIUM | ‚úÖ DONE |
| FIX-16 | üî¥ HIGH | ‚úÖ DONE |
| FIX-17 | üü° MEDIUM | ‚è≠Ô∏è WONTFIX |
| FIX-18 | üü¢ LOW | ‚úÖ DONE |
| FIX-20 | üü¢ LOW | ‚úÖ DONE |
| FIX-21 | üü° MEDIUM | ‚úÖ DONE |
| FIX-23 | üü¢ LOW | ‚ùå NOT AN ISSUE |
| FIX-24 | üü° MEDIUM | ‚úÖ DONE |
| FIX-25 | üî¥ HIGH | ‚úÖ DONE |
| FIX-26 | üü° MEDIUM | ‚úÖ DONE |
| FIX-30 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-31 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-32 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-33 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-34 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-35 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-36 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-37 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-38 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |
| FIX-39 | üü¢ LOW | ‚è≠Ô∏è WONTFIX |

**–ò—Ç–æ–≥–æ:** 8 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ, 1 –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, 11 WONTFIX (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

---

### [FIX-30] –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏–º—ë–Ω –ø–æ–ª–µ–π carbohydrates vs carbs
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 3.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** CONSISTENCY
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ø—Ä–æ–º–ø—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –∏–º–µ–Ω–∞: `carbohydrates` (ANALYZE_FOOD_PROMPT, RECALCULATE_MINIAPP_PROMPT) –∏ `carbs` (ANALYZE_FOOD_SMART_PROMPT ingredients).

**–í–µ—Ä–¥–∏–∫—Ç:** –≠—Ç–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ. `carbohydrates` ‚Äî –¥–ª—è –∏—Ç–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –±–ª—é–¥–∞, `carbs` ‚Äî –¥–ª—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–∫–æ—Ä–æ—á–µ). Pydantic —Å—Ö–µ–º—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞.

---

### [FIX-31] –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ few-shot –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 3.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** IMPROVEMENT
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –í ANALYZE_FOOD_PROMPT –∏ CLASSIFY_AND_ANALYZE_PROMPT –Ω–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤, —Ç–æ–ª—å–∫–æ –≤ ANALYZE_FOOD_SMART_PROMPT.

**–í–µ—Ä–¥–∏–∫—Ç:** –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤. json_mode=True –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. SMART —Ä–µ–∂–∏–º —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è.

---

### [FIX-32] –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ edge cases –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 3.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** IMPROVEMENT
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–º–ø—Ç—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è edge cases: –Ω–µ—á—ë—Ç–∫–æ–µ —Ñ–æ—Ç–æ, —É–ø–∞–∫–æ–≤–∫–∞ —Å —ç—Ç–∏–∫–µ—Ç–∫–æ–π, –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª—é–¥.

**–í–µ—Ä–¥–∏–∫—Ç:** GPT-4o —Ö–æ—Ä–æ—à–æ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å —ç—Ç–∏–º–∏ —Å–ª—É—á–∞—è–º–∏ –±–µ–∑ —è–≤–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —É–≤–µ–ª–∏—á–∏—Ç –¥–ª–∏–Ω—É –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ.

---

### [FIX-33] –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –∂—ë—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω –∫–∞–∫ 'audio.ogg'
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 4.2
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** IMPROVEMENT
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `transcribe_audio()` —Ñ–∞–π–ª –≤—Å–µ–≥–¥–∞ –∏–º–µ–Ω—É–µ—Ç—Å—è 'audio.ogg'.

**–í–µ—Ä–¥–∏–∫—Ç:** Whisper API –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É, –Ω–µ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç voice –≤ OGG, —Ç–∞–∫ —á—Ç–æ —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

### [FIX-34] –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (25MB –ª–∏–º–∏—Ç)
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 4.2
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** IMPROVEMENT
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –∞—É–¥–∏–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Whisper.

**–í–µ—Ä–¥–∏–∫—Ç:** Telegram –ª–∏–º–∏—Ç–∏—Ä—É–µ—Ç voice messages –¥–æ 50MB. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ >25MB. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ Whisper –≤–µ—Ä–Ω—ë—Ç BadRequestError, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è.

---

### [FIX-35] –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 5.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** IMPROVEMENT
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–∏ –±–ª—é–¥–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è.

**–í–µ—Ä–¥–∏–∫—Ç:** –î–ª—è MVP –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `original_analysis` –≤ Meal –º–æ–¥–µ–ª—å.

---

### [FIX-36] –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race conditions –ø—Ä–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è—Ö
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 5.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** IMPROVEMENT
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–∞ –±—ã—Å—Ç—Ä—ã—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å.

**–í–µ—Ä–¥–∏–∫—Ç:** –ö—Ä–∞–π–Ω–µ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –û–∫–Ω–æ 5 –º–∏–Ω—É—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –æ–¥–Ω–æ–º—É.

---

### [FIX-37] –ù–µ—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 6.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** SECURITY
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç—ã –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

**–í–µ—Ä–¥–∏–∫—Ç:** json_mode –∏ –Ω–∏–∑–∫–∞—è temperature —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∑–∞—â–∏—â–∞—é—Ç. –ú–æ–¥–µ–ª—å –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π. –†–∏—Å–∫ –º–∏–Ω–∏–º–∞–ª–µ–Ω –¥–ª—è health coaching –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

### [FIX-38] –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã –≤–≤–æ–¥–∞
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 6.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** SECURITY
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —è–≤–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞.

**–í–µ—Ä–¥–∏–∫—Ç:** Telegram –ª–∏–º–∏—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ ~4096 —Å–∏–º–≤–æ–ª–æ–≤. –≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ trim_messages_to_token_limit.

---

### [FIX-39] –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
**–†–æ–¥–∏—Ç–µ–ª—å:** –ó–∞–¥–∞—á–∞ 6.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ LOW
**–¢–∏–ø:** SECURITY
**–°—Ç–∞—Ç—É—Å:** ‚è≠Ô∏è WONTFIX

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö injection –∞—Ç–∞–∫.

**–í–µ—Ä–¥–∏–∫—Ç:** –î–ª—è MVP –∏–∑–±—ã—Ç–æ—á–Ω–æ. –ü—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "ignore", "system prompt" –∏ —Ç.–¥.)

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2026-02-01*
*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-02-01*
*–ê—É–¥–∏—Ç –ø—Ä–æ–≤–µ–¥—ë–Ω: 2026-02-01*
*FIX-–∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã: 2026-02-01*
*–ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω: 2026-02-01*

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –ê–£–î–ò–¢–ê

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–£–î–ò–¢ –ó–ê–í–ï–†–®–Å–ù (100%)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 0
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 8 (FIX-15, 16, 18, 20, 21, 24, 25, 26)
**–û—Ç–ª–æ–∂–µ–Ω–æ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):** 11

**–û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∞—É–¥–∏—Ç–∞:**
1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ OpenAI API
2. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω retry —Å exponential backoff (tenacity)
3. –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å token counting (tokens.py)
5. –î–æ–±–∞–≤–ª–µ–Ω finish_reason –∏ is_truncated –≤ AIResponse
6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã Pydantic —Å—Ö–µ–º—ã —Å Annotated types
7. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è:**
1. Rate limiting —á–µ—Ä–µ–∑ Redis –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
2. Circuit breaker –¥–ª—è graceful degradation
3. Alerting –Ω–∞ –∞–Ω–æ–º–∞–ª–∏–∏ usage –≤ Sentry/Datadog
